---
title: API Server
description: Effect HttpApi server powering auth, organizations, and invitations with OpenAPI spec generation.
---

# API Server (`apps/api`)

The API server is the backbone of tx-agent-kit. It is built on [Effect HttpApi](https://effect.website/docs/platform/http-api) and exposes a fully typed, schema-validated REST API. The server runs on port **4000** by default.

## Architecture

The API server follows a layered architecture where routes delegate to domain services, which in turn interact with repositories through Effect's dependency injection system.

```
Request -> Route Handler -> Domain Service -> Repository Port -> DB Repository
```

Each route handler extracts the authenticated principal from the `Authorization` header, invokes the appropriate domain service, and maps the result to an API response shape.

## Route Groups

The API exposes the following route groups:

### Auth (`/v1/auth`)

Auth routes use the `custom` kind marker since they expose domain-specific operations rather than standard CRUD.

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/v1/auth/sign-up` | POST | Register a new user and return a session |
| `/v1/auth/sign-in` | POST | Authenticate and return a session |
| `/v1/auth/me` | GET | Return the authenticated principal |
| `/v1/auth/me` | DELETE | Delete the authenticated user |

### Organizations (`/v1/organizations`)

Organization routes use the `crud` kind marker and expose the full CRUD surface.

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/v1/organizations` | GET | List organizations for the current user (paginated) |
| `/v1/organizations/:id` | GET | Get a single organization by ID |
| `/v1/organizations/many` | POST | Get multiple organizations by IDs |
| `/v1/organizations` | POST | Create an organization |
| `/v1/organizations/:id` | PATCH | Update an organization |
| `/v1/organizations/:id` | DELETE | Remove an organization |

### Invitations (`/v1/invitations`)

Invitation endpoints are nested under the organizations group and include idempotent acceptance.

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/v1/invitations` | GET | List invitations for the current user |
| `/v1/invitations/:id` | GET | Get a single invitation |
| `/v1/invitations` | POST | Create an invitation |
| `/v1/invitations/:id` | PATCH | Update an invitation |
| `/v1/invitations/:id` | DELETE | Remove an invitation |
| `/v1/invitations/accept/:token` | POST | Accept an invitation (idempotent) |

## Kind Markers

Every route file declares an explicit kind marker that must match the corresponding repository port kind:

```typescript
// apps/api/src/routes/organizations.ts
export const OrganizationsRouteKind = 'crud' as const

// apps/api/src/routes/auth.ts
export const AuthRouteKind = 'custom' as const
```

The enforcement layer validates that `crud` routes expose the full list/get/create/update/remove surface, and that `custom` routes do not accidentally implement the full CRUD pattern.

## OpenAPI Generation

The API spec is generated from the Effect HttpApi definitions:

```bash
pnpm openapi:generate
```

This produces `apps/api/openapi.json`, which is then consumed by Orval to generate typed client hooks for the web and mobile apps.

When the API server is running (default `http://localhost:4000`), runtime docs are available at:

- `/docs` for Swagger UI
- `/openapi.json` for the raw OpenAPI document

Both runtime endpoints come from the same Effect HttpApi definitions. The generated `apps/api/openapi.json` remains the repo artifact used by downstream generation workflows (including `pnpm docs:api:generate`).

## Config and Environment

Runtime environment variables are read exclusively through `apps/api/src/config/env.ts`. Direct `process.env` access is forbidden in route and service modules.

## Integration Testing

The API integration suite lives at `apps/api/src/api.integration.test.ts` and uses the standardized harness:

```typescript
import { createDbAuthContext } from '@tx-agent-kit/testkit'

const ctx = createDbAuthContext({
  apiCwd: resolve(dirname(fileURLToPath(import.meta.url)), '..')
})
```

The harness provides authenticated HTTP helpers and handles DB reset between test cases. Manual process spawning and direct `createSqlTestContext` wiring are forbidden in the API integration suite.
