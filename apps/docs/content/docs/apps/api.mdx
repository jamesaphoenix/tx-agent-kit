---
title: API Server
description: Effect HttpApi server powering auth, organizations, teams, billing/subscriptions, and permissions with OpenAPI spec generation.
---

# API Server (`apps/api`)

The API server is the backbone of tx-agent-kit. It is built on [Effect HttpApi](https://effect.website/docs/platform/http-api) and exposes a fully typed, schema-validated REST API. The server runs on port **4000** by default.

## Architecture

The API server follows a layered architecture where routes delegate to domain services, which in turn interact with repositories through Effect's dependency injection system.

```
Request -> Route Handler -> Domain Service -> Repository Port -> DB Repository
```

Each route handler extracts the authenticated principal from the `Authorization` header, invokes the appropriate domain service, and maps the result to an API response shape.

## Route Groups

OpenAPI tags map directly to generated API reference pages:

- **auth** (`/v1/auth/*`): password auth, refresh token rotation, Google OIDC start/callback, and password reset flows.
- **organizations** (`/v1/organizations/*` plus `/v1/invitations/*`): org CRUD and invitation lifecycle.
- **teams** (`/v1/teams/*`): team-level management.
- **billing** (`/v1/organizations/{organizationId}/billing`, `/v1/billing/*`, `/v1/webhooks/stripe`): subscription state, checkout/portal session creation, usage summaries, and Stripe webhook synchronization.
- **permissions** (`/v1/permissions`, `/v1/permissions/me`): role-permission map and current-user permission resolution.
- **health** (`/health`): service health probe.

For full request/response shapes, use the generated pages in `docs/api-reference/*` or runtime `/openapi.json`.

## Billing and Roles

Billing authorization is role-gated:

- `owner` and `admin` can manage billing (`PATCH /v1/organizations/{organizationId}/billing`, `POST /v1/billing/checkout`, `POST /v1/billing/portal`).
- `member` cannot manage billing and receives `401` on management endpoints.
- Subscription state is synced from Stripe webhooks (`/v1/webhooks/stripe`) into organization billing fields (`isSubscribed`, `subscriptionStatus`, `subscriptionPlan`).

## Kind Markers

Every route file declares an explicit kind marker that must match the corresponding repository port kind:

```typescript
// apps/api/src/routes/organizations.ts
export const OrganizationsRouteKind = 'crud' as const

// apps/api/src/routes/auth.ts
export const AuthRouteKind = 'custom' as const
```

The enforcement layer validates that `crud` routes expose the full list/get/create/update/remove surface, and that `custom` routes do not accidentally implement the full CRUD pattern.

## OpenAPI Generation

The API spec is generated from the Effect HttpApi definitions:

```bash
pnpm openapi:generate
```

This produces `apps/api/openapi.json`, which is then consumed by Orval to generate typed client hooks for the web and mobile apps.

When the API server is running (default `http://localhost:4000`), runtime docs are available at:

- `/docs` for Swagger UI
- `/openapi.json` for the raw OpenAPI document

Both runtime endpoints come from the same Effect HttpApi definitions. The generated `apps/api/openapi.json` remains the repo artifact used by downstream generation workflows (including `pnpm docs:api:generate`).

## Config and Environment

Runtime environment variables are read exclusively through `apps/api/src/config/env.ts`. Direct `process.env` access is forbidden in route and service modules.

## Integration Testing

The API integration suite lives at `apps/api/src/api.integration.test.ts` and uses the standardized harness:

```typescript
import { createDbAuthContext } from '@tx-agent-kit/testkit'

const ctx = createDbAuthContext({
  apiCwd: resolve(dirname(fileURLToPath(import.meta.url)), '..')
})
```

The harness provides authenticated HTTP helpers and handles DB reset between test cases. Manual process spawning and direct `createSqlTestContext` wiring are forbidden in the API integration suite.
