openapi: 3.1.0
info:
  title: tx-agent-kit API
  version: 0.1.0
  summary: Effect-based API for auth, workspaces, invitations, and tasks.
  description: >
    Contract for `apps/api`. Domain behavior is modeled as closed invariants:
    only valid state transitions are accepted at API boundaries.
servers:
  - url: http://localhost:4000
    description: Local development API
tags:
  - name: Health
  - name: Auth
  - name: Workspaces
  - name: Invitations
  - name: Tasks
x-ddd:
  boundedContexts:
    - name: IdentityAccess
      owns:
        - Sign up/sign in
        - Session token principal
    - name: Collaboration
      owns:
        - Workspaces
        - Invitations
        - Membership
    - name: WorkExecution
      owns:
        - Tasks
  closedInvariants:
    - id: INV-AUTH-001
      rule: Password must be at least 8 characters.
    - id: INV-WS-001
      rule: Workspace members are the only actors allowed to read/create tasks in that workspace.
    - id: INV-INV-001
      rule: Invitations can be accepted only when status is pending, not expired, and email matches authenticated principal.
    - id: INV-ARCH-001
      rule: Domain mutations are accepted only via API/application services; direct UI-to-DB writes are forbidden.
paths:
  /health:
    get:
      tags: [Health]
      operationId: getHealth
      responses:
        '200':
          description: Healthy service.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Health'
  /v1/auth/sign-up:
    post:
      tags: [Auth]
      operationId: signUp
      x-invariants: [INV-AUTH-001]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SignUpRequest'
      responses:
        '201':
          description: Auth session created.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '409':
          $ref: '#/components/responses/Conflict'
  /v1/auth/sign-in:
    post:
      tags: [Auth]
      operationId: signIn
      x-invariants: [INV-AUTH-001]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SignInRequest'
      responses:
        '200':
          description: Auth session created.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
  /v1/auth/me:
    get:
      tags: [Auth]
      operationId: getPrincipal
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Authenticated principal.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthPrincipal'
        '401':
          $ref: '#/components/responses/Unauthorized'
  /v1/workspaces:
    get:
      tags: [Workspaces]
      operationId: listWorkspaces
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Workspaces visible to current user.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListWorkspacesResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
    post:
      tags: [Workspaces]
      operationId: createWorkspace
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateWorkspaceRequest'
      responses:
        '201':
          description: Workspace created.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Workspace'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
  /v1/invitations:
    get:
      tags: [Invitations]
      operationId: listInvitations
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Invitations in user's workspace graph.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListInvitationsResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
    post:
      tags: [Invitations]
      operationId: createInvitation
      x-invariants: [INV-WS-001]
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateInvitationRequest'
      responses:
        '201':
          description: Invitation created.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Invitation'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '409':
          $ref: '#/components/responses/Conflict'
  /v1/invitations/{token}/accept:
    post:
      tags: [Invitations]
      operationId: acceptInvitation
      x-invariants: [INV-INV-001]
      security:
        - BearerAuth: []
      parameters:
        - name: token
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Invitation accepted.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AcceptInvitationResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
  /v1/tasks:
    get:
      tags: [Tasks]
      operationId: listTasks
      x-invariants: [INV-WS-001]
      security:
        - BearerAuth: []
      parameters:
        - name: workspaceId
          in: query
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Tasks in workspace.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListTasksResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
    post:
      tags: [Tasks]
      operationId: createTask
      x-invariants: [INV-WS-001]
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateTaskRequest'
      responses:
        '201':
          description: Task created.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Task'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  responses:
    BadRequest:
      description: Invalid request payload or business input.
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    Unauthorized:
      description: Missing or invalid authorization.
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    NotFound:
      description: Resource not found.
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    Conflict:
      description: Uniqueness/conflict domain violation.
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
  schemas:
    Error:
      type: object
      properties:
        message:
          type: string
      required: [message]
    Health:
      type: object
      properties:
        status:
          type: string
          enum: [healthy]
        timestamp:
          type: string
        service:
          type: string
      required: [status, timestamp, service]
    User:
      type: object
      properties:
        id:
          type: string
          format: uuid
        email:
          type: string
          format: email
        name:
          type: string
        createdAt:
          type: string
      required: [id, email, name, createdAt]
    AuthPrincipal:
      type: object
      properties:
        userId:
          type: string
          format: uuid
        email:
          type: string
          format: email
        workspaceId:
          type: string
          format: uuid
        roles:
          type: array
          items:
            type: string
      required: [userId, email, roles]
    SignUpRequest:
      type: object
      properties:
        email:
          type: string
          format: email
        password:
          type: string
          minLength: 8
        name:
          type: string
          minLength: 1
      required: [email, password, name]
    SignInRequest:
      type: object
      properties:
        email:
          type: string
          format: email
        password:
          type: string
          minLength: 8
      required: [email, password]
    AuthResponse:
      type: object
      properties:
        token:
          type: string
        user:
          $ref: '#/components/schemas/User'
      required: [token, user]
    Workspace:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        ownerUserId:
          type: string
          format: uuid
        createdAt:
          type: string
      required: [id, name, ownerUserId, createdAt]
    ListWorkspacesResponse:
      type: object
      properties:
        workspaces:
          type: array
          items:
            $ref: '#/components/schemas/Workspace'
      required: [workspaces]
    CreateWorkspaceRequest:
      type: object
      properties:
        name:
          type: string
          minLength: 2
          maxLength: 64
      required: [name]
    Invitation:
      type: object
      properties:
        id:
          type: string
          format: uuid
        workspaceId:
          type: string
          format: uuid
        email:
          type: string
          format: email
        role:
          type: string
          enum: [admin, member]
        status:
          type: string
          enum: [pending, accepted, revoked, expired]
        invitedByUserId:
          type: string
          format: uuid
        token:
          type: string
        expiresAt:
          type: string
        createdAt:
          type: string
      required: [id, workspaceId, email, role, status, invitedByUserId, token, expiresAt, createdAt]
    ListInvitationsResponse:
      type: object
      properties:
        invitations:
          type: array
          items:
            $ref: '#/components/schemas/Invitation'
      required: [invitations]
    CreateInvitationRequest:
      type: object
      properties:
        workspaceId:
          type: string
          format: uuid
        email:
          type: string
          format: email
        role:
          type: string
          enum: [admin, member]
      required: [workspaceId, email, role]
    AcceptInvitationResponse:
      type: object
      properties:
        accepted:
          type: boolean
      required: [accepted]
    Task:
      type: object
      properties:
        id:
          type: string
          format: uuid
        workspaceId:
          type: string
          format: uuid
        title:
          type: string
        description:
          type: [string, 'null']
        status:
          type: string
          enum: [todo, in_progress, done]
        createdByUserId:
          type: string
          format: uuid
        createdAt:
          type: string
      required: [id, workspaceId, title, description, status, createdByUserId, createdAt]
    ListTasksResponse:
      type: object
      properties:
        tasks:
          type: array
          items:
            $ref: '#/components/schemas/Task'
      required: [tasks]
    CreateTaskRequest:
      type: object
      properties:
        workspaceId:
          type: string
          format: uuid
        title:
          type: string
          minLength: 1
          maxLength: 200
        description:
          type: string
          maxLength: 2000
      required: [workspaceId, title]
